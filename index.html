<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Своя Игра - Настройка</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        /* Исправление выравнивания радиокнопок */
        .radio-option {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            justify-content: flex-start !important;
            text-align: left !important;
            width: 100%;
            padding: 10px;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            margin: 0 12px 0 0 !important;
            flex-shrink: 0 !important;
            width: 18px;
            height: 18px;
        }

        .radio-option span {
            margin: 0 !important;
            display: inline-block !important;
            text-align: left !important;
            flex: 1;
        }

        /* Стилизация блока загрузки как на странице теста */
        #fileUploadSection {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            background-color: #fcfcfc;
            text-align: center;
        }

        .file-input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        #fileInput {
            display: none;
        }

        .uploaded-file-info {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            display: none;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
            text-align: left;
            width: 100%;
        }

        .uploaded-file-info.success {
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #166534;
        }

        .uploaded-file-info.error {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #dc2626;
        }

        .uploaded-file-info.success::before {
            content: "✅";
        }

        .uploaded-file-info.error::before {
            content: "❌";
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <img src="images/fml366_200.png" alt="ФМЛ 366">
                <h1>Своя Игра</h1>
            </div>
        </div>
    </header>

    <main class="setup-container">
        <div class="setup-card">
            <h2>Настройка игры</h2>
            
            <div class="form-group">
                <div class="source-options">
                    <div class="source-options-header">Источник вопросов</div>
                    <label class="radio-option" for="useLocalBase">
                        <input type="radio" name="questionSource" id="useLocalBase" value="local" checked>
                        <span>Использовать локальную базу вопросов</span>
                    </label>
                    <label class="radio-option" for="useFileUpload">
                        <input type="radio" name="questionSource" id="useFileUpload" value="file">
                        <span>Загрузить файл с вопросами</span>
                    </label>
                </div>
            </div>
            
            <div id="localBaseSection" class="form-group">
                <label for="questionBase">База вопросов:</label>
                <select id="questionBase" class="question-base-select">
                    <option value="" disabled selected>Загрузка...</option>
                </select>
            </div>
            
            <div id="fileUploadSection" class="form-group" style="display: none;">
                <label>Загрузить файл с вопросами:</label>
                <div class="file-input-container">
                    <input type="file" id="fileInput" accept=".json">
                    <button type="button" id="uploadFileBtn" class="btn btn-secondary">Выбрать JSON файл</button>
                    <button type="button" id="clearUploadedBtn" class="btn btn-outline" style="display: none;">Очистить</button>
                    <div id="uploadedFileInfo" class="uploaded-file-info"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="playerCount">Количество игроков (2-6):</label>
                <input type="number" id="playerCount" min="2" max="6" value="2">
            </div>

            <div id="playerNames" class="player-names">
                <!-- Поля для имен игроков будут добавлены динамически -->
            </div>

            <button id="startGame" class="btn btn-primary">Начать игру</button>
        </div>
    </main>

    <footer>
        <p>Разработано для образовательных целей | 2025</p>
    </footer>

    <script src="js/data.js"></script>
    <script>
        const playerCountInput = document.getElementById('playerCount');
        const playerNamesContainer = document.getElementById('playerNames');
        const startGameButton = document.getElementById('startGame');
        const questionBaseSelect = document.getElementById('questionBase');
        const fileInput = document.getElementById('fileInput');
        const uploadFileBtn = document.getElementById('uploadFileBtn');
        const clearUploadedBtn = document.getElementById('clearUploadedBtn');
        const uploadedFileInfo = document.getElementById('uploadedFileInfo');
        const useLocalBaseRadio = document.getElementById('useLocalBase');
        const useFileUploadRadio = document.getElementById('useFileUpload');
        const localBaseSection = document.getElementById('localBaseSection');
        const fileUploadSection = document.getElementById('fileUploadSection');
        
        let uploadedQuestionsData = null;
        let uploadedFileName = '';
        
        function toggleSourceMode() {
            const useLocal = useLocalBaseRadio.checked;
            if (useLocal) {
                localBaseSection.style.display = 'block';
                fileUploadSection.style.display = 'none';
                clearUploadedFile();
            } else {
                localBaseSection.style.display = 'none';
                fileUploadSection.style.display = 'block';
                questionBaseSelect.selectedIndex = -1;
            }
            validateForm();
        }
        
        function clearUploadedFile() {
            uploadedQuestionsData = null;
            uploadedFileName = '';
            fileInput.value = '';
            clearUploadedBtn.style.display = 'none';
            uploadedFileInfo.style.display = 'none';
            uploadedFileInfo.className = 'uploaded-file-info';
            uploadedFileInfo.textContent = '';
        }
        
        function showFileError(message) {
            uploadedFileInfo.style.display = 'flex';
            uploadedFileInfo.className = 'uploaded-file-info error';
            uploadedFileInfo.innerHTML = message;
            uploadedQuestionsData = null;
            uploadedFileName = '';
            clearUploadedBtn.style.display = 'inline-block';
            validateForm();
        }
        
        function showFileSuccess(fileName, subject) {
            uploadedFileInfo.style.display = 'flex';
            uploadedFileInfo.className = 'uploaded-file-info success';
            uploadedFileInfo.innerHTML = ` ${fileName} (${subject || 'Загруженная база'})`;
            clearUploadedBtn.style.display = 'inline-block';
        }
        
        function validateForm() {
            const useLocal = useLocalBaseRadio.checked;
            let isValid = true;
            if (useLocal) {
                isValid = questionBaseSelect.value !== '';
            } else {
                isValid = uploadedQuestionsData !== null;
            }
            startGameButton.disabled = !isValid;
        }

        // Детальная валидация структуры файла вопросов
        function validateQuestionsFile(data) {
            const errors = [];
            
            if (!data || typeof data !== 'object') {
                return { valid: false, error: 'Некорректный формат данных: ожидается JSON объект' };
            }
            
            if (!data.categories || !Array.isArray(data.categories)) {
                return { valid: false, error: 'Отсутствует поле "categories" или оно не является массивом' };
            }
            
            if (data.categories.length === 0) {
                return { valid: false, error: 'Массив категорий не может быть пустым' };
            }
            
            for (let i = 0; i < data.categories.length; i++) {
                const category = data.categories[i];
                const catNum = i + 1;
                
                if (!category.id) {
                    errors.push(`Категория ${catNum}: отсутствует поле "id"`);
                }
                if (!category.name || typeof category.name !== 'string') {
                    errors.push(`Категория ${catNum}: отсутствует или некорректно поле "name"`);
                }
                if (!category.questions || !Array.isArray(category.questions)) {
                    errors.push(`Категория ${catNum}: отсутствует или некорректно поле "questions"`);
                } else if (category.questions.length === 0) {
                    errors.push(`Категория ${catNum}: массив вопросов не может быть пустым`);
                } else {
                    for (let j = 0; j < category.questions.length; j++) {
                        const question = category.questions[j];
                        const qNum = j + 1;
                        
                        if (!question.text || typeof question.text !== 'string') {
                            errors.push(`Категория ${catNum}, вопрос ${qNum}: отсутствует или некорректно поле "text"`);
                        }
                        if (!question.options || !Array.isArray(question.options)) {
                            errors.push(`Категория ${catNum}, вопрос ${qNum}: отсутствует или некорректно поле "options"`);
                        } else if (question.options.length < 2) {
                            errors.push(`Категория ${catNum}, вопрос ${qNum}: должно быть минимум 2 варианта ответа`);
                        }
                        if (typeof question.correctAnswer !== 'number') {
                            errors.push(`Категория ${catNum}, вопрос ${qNum}: отсутствует или некорректно поле "correctAnswer"`);
                        } else if (question.correctAnswer < 0 || question.options && question.correctAnswer >= question.options.length) {
                            errors.push(`Категория ${catNum}, вопрос ${qNum}: индекс правильного ответа выходит за пределы вариантов`);
                        }
                        if (typeof question.points !== 'number' || question.points <= 0) {
                            errors.push(`Категория ${catNum}, вопрос ${qNum}: поле "points" должно быть положительным числом`);
                        }
                    }
                }
            }
            
            if (errors.length > 0) {
                return { valid: false, error: errors[0] + (errors.length > 1 ? ` (и еще ${errors.length - 1} ошибок)` : '') };
            }
            
            return { valid: true };
        }

        // Загрузка баз вопросов - улучшенная версия с обработкой ошибок
        async function loadQuestionBases() {
            try {
                let files = await getAvailableQuestionFiles();
                
                if (!files || files.length === 0) {
                    try {
                        const response = await fetch('data/questions.json');
                        if (response.ok) {
                            const config = await response.json();
                            if (config.bases && Array.isArray(config.bases)) {
                                files = config.bases.map(base => ({
                                    name: base.file,
                                    path: `data/${base.file}`,
                                    subject: base.name
                                }));
                            }
                        }
                    } catch (e) {
                        console.warn('Не удалось загрузить questions.json:', e);
                        files = [
                            { name: 'history1.json', path: 'data/history1.json', subject: 'История' },
                            { name: 'math1.json', path: 'data/math1.json', subject: 'Математика' }
                        ];
                    }
                }
                
                questionBaseSelect.innerHTML = '';
                
                if (!files || files.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Базы вопросов не найдены';
                    questionBaseSelect.appendChild(option);
                    return;
                }
                
                files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.path;
                    option.textContent = file.subject || file.name;
                    questionBaseSelect.appendChild(option);
                });
                validateForm();
            } catch (e) {
                console.error('Критическая ошибка загрузки баз вопросов:', e);
                questionBaseSelect.innerHTML = '<option value="">Ошибка загрузки</option>';
            }
        }
        
        uploadFileBtn.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                // Детальная валидация загруженного файла
                const validation = validateQuestionsFile(data);
                
                if (!validation.valid) {
                    showFileError(`Ошибка валидации: ${validation.error}.<br><br>Загрузите другой файл или выберите базу вопросов из списка.`);
                    return;
                }
                
                uploadedQuestionsData = data;
                uploadedFileName = file.name;
                
                showFileSuccess(file.name, data.subject);
                validateForm();
            } catch (error) {
                console.error('Ошибка загрузки файла:', error);
                showFileError('Ошибка при чтении файла: некорректный JSON формат');
            }
        });
        
        clearUploadedBtn.addEventListener('click', () => {
            clearUploadedFile();
            validateForm();
        });
        
        useLocalBaseRadio.addEventListener('change', toggleSourceMode);
        useFileUploadRadio.addEventListener('change', toggleSourceMode);
        
        function generatePlayerInputs(count) {
            playerNamesContainer.innerHTML = '';
            for (let i = 1; i <= count; i++) {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `
                    <label for="player${i}">Имя игрока ${i}:</label>
                    <input type="text" id="player${i}" placeholder="Игрок ${i}" value="Игрок ${i}">
                `;
                playerNamesContainer.appendChild(div);
            }
        }

        generatePlayerInputs(2);
        loadQuestionBases();
        toggleSourceMode();

        playerCountInput.addEventListener('change', (e) => {
            const count = parseInt(e.target.value);
            if (count >= 2 && count <= 6) {
                generatePlayerInputs(count);
            }
        });
        
        questionBaseSelect.addEventListener('change', validateForm);

        startGameButton.addEventListener('click', () => {
            const playerCount = parseInt(playerCountInput.value);
            const players = [];
            for (let i = 1; i <= playerCount; i++) {
                const name = document.getElementById(`player${i}`).value.trim();
                players.push({ id: i, name: name || `Игрок ${i}`, score: 0 });
            }

            const gameState = {
                players: players,
                currentPlayer: 0,
                currentQuestion: null,
                answeredQuestions: [],
                gameStatus: 'playing'
            };
            
            if (useLocalBaseRadio.checked) {
                const selectedBase = questionBaseSelect.value;
                if (!selectedBase) {
                    alert('Пожалуйста, выберите базу вопросов');
                    return;
                }
                gameState.questionsFile = selectedBase;
            } else {
                if (!uploadedQuestionsData) {
                    alert('Пожалуйста, загрузите корректный файл с вопросами');
                    return;
                }
                gameState.uploadedQuestions = uploadedQuestionsData;
                gameState.questionsFile = 'uploaded';
            }

            try {
                localStorage.setItem('gameState', JSON.stringify(gameState));
                console.log('Game state saved:', gameState);
                window.location.href = 'game.html';
            } catch (e) {
                console.error('Ошибка сохранения состояния игры:', e);
                alert('Ошибка сохранения состояния игры. Проверьте настройки localStorage.');
            }
        });
    </script>
</body>
</html>
