<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–≤–æ—è –ò–≥—Ä–∞ - –ù–∞—Å—Ç—Ä–æ–π–∫–∞</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–æ–∫ */
        .radio-option {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            justify-content: flex-start !important;
            text-align: left !important;
            width: 100%;
            padding: 10px;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            margin: 0 12px 0 0 !important;
            flex-shrink: 0 !important;
            width: 18px;
            height: 18px;
        }

        .radio-option span {
            margin: 0 !important;
            display: inline-block !important;
            text-align: left !important;
            flex: 1;
        }

        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –±–ª–æ–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ç–µ—Å—Ç–∞ */
        #fileUploadSection {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            background-color: #fcfcfc;
            text-align: center;
        }

        .file-input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        #fileInput {
            display: none;
        }

        .uploaded-file-info {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            display: none;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
            text-align: left;
            width: 100%;
        }

        .uploaded-file-info.success {
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #166534;
        }

        .uploaded-file-info.error {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #dc2626;
        }

        .uploaded-file-info.success::before {
            content: "‚úÖ";
        }

        .uploaded-file-info.error::before {
            content: "‚ùå";
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <img src="images/fml366_200.png" alt="–§–ú–õ 366">
                <h1>–°–≤–æ—è –ò–≥—Ä–∞</h1>
            </div>
        </div>
    </header>

    <main class="setup-container">
        <div class="setup-card">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–≥—Ä—ã</h2>
            
            <div class="form-group">
                <div class="source-options">
                    <div class="source-options-header">–ò—Å—Ç–æ—á–Ω–∏–∫ –≤–æ–ø—Ä–æ—Å–æ–≤</div>
                    <label class="radio-option" for="useLocalBase">
                        <input type="radio" name="questionSource" id="useLocalBase" value="local" checked>
                        <span>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É –≤–æ–ø—Ä–æ—Å–æ–≤</span>
                    </label>
                    <label class="radio-option" for="useFileUpload">
                        <input type="radio" name="questionSource" id="useFileUpload" value="file">
                        <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏</span>
                    </label>
                </div>
            </div>
            
            <div id="localBaseSection" class="form-group">
                <label for="questionBase">–ë–∞–∑–∞ –≤–æ–ø—Ä–æ—Å–æ–≤:</label>
                <select id="questionBase" class="question-base-select">
                    <option value="" disabled selected>–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                </select>
            </div>
            
            <div id="fileUploadSection" class="form-group" style="display: none;">
                <label>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏:</label>
                <div class="file-input-container">
                    <input type="file" id="fileInput" accept=".json">
                    <button type="button" id="uploadFileBtn" class="btn btn-secondary">–í—ã–±—Ä–∞—Ç—å JSON —Ñ–∞–π–ª</button>
                    <button type="button" id="clearUploadedBtn" class="btn btn-outline" style="display: none;">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    <div id="uploadedFileInfo" class="uploaded-file-info"></div>
                </div>
                <p style="margin-top: 12px; font-size: 0.9rem; color: var(--text-secondary);">
                    <a href="data/example_questions.json" download="example_questions.json" style="color: var(--primary-color); text-decoration: none;">üì• –°–∫–∞—á–∞—Ç—å –ø—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏</a>
                </p>
            </div>
            
            <div class="form-group">
                <label for="playerCount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ (2-6):</label>
                <input type="number" id="playerCount" min="2" max="6" value="2">
            </div>

            <div id="playerNames" class="player-names">
                <!-- –ü–æ–ª—è –¥–ª—è –∏–º–µ–Ω –∏–≥—Ä–æ–∫–æ–≤ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>

            <button id="startGame" class="btn btn-primary">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
        </div>
    </main>

    <footer>
        <p>–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–ª—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª–µ–π | 2025</p>
    </footer>

    <script src="js/data.js"></script>
    <script>
        const playerCountInput = document.getElementById('playerCount');
        const playerNamesContainer = document.getElementById('playerNames');
        const startGameButton = document.getElementById('startGame');
        const questionBaseSelect = document.getElementById('questionBase');
        const fileInput = document.getElementById('fileInput');
        const uploadFileBtn = document.getElementById('uploadFileBtn');
        const clearUploadedBtn = document.getElementById('clearUploadedBtn');
        const uploadedFileInfo = document.getElementById('uploadedFileInfo');
        const useLocalBaseRadio = document.getElementById('useLocalBase');
        const useFileUploadRadio = document.getElementById('useFileUpload');
        const localBaseSection = document.getElementById('localBaseSection');
        const fileUploadSection = document.getElementById('fileUploadSection');
        
        let uploadedQuestionsData = null;
        let uploadedFileName = '';
        
        function toggleSourceMode() {
            const useLocal = useLocalBaseRadio.checked;
            if (useLocal) {
                localBaseSection.style.display = 'block';
                fileUploadSection.style.display = 'none';
                clearUploadedFile();
            } else {
                localBaseSection.style.display = 'none';
                fileUploadSection.style.display = 'block';
                questionBaseSelect.selectedIndex = -1;
            }
            validateForm();
        }
        
        function clearUploadedFile() {
            uploadedQuestionsData = null;
            uploadedFileName = '';
            fileInput.value = '';
            clearUploadedBtn.style.display = 'none';
            uploadedFileInfo.style.display = 'none';
            uploadedFileInfo.className = 'uploaded-file-info';
            uploadedFileInfo.textContent = '';
        }
        
        function showFileError(message) {
            uploadedFileInfo.style.display = 'flex';
            uploadedFileInfo.className = 'uploaded-file-info error';
            uploadedFileInfo.innerHTML = message;
            uploadedQuestionsData = null;
            uploadedFileName = '';
            clearUploadedBtn.style.display = 'inline-block';
            validateForm();
        }
        
        function showFileSuccess(fileName, subject) {
            uploadedFileInfo.style.display = 'flex';
            uploadedFileInfo.className = 'uploaded-file-info success';
            uploadedFileInfo.innerHTML = ` ${fileName} (${subject || '–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–∞—è –±–∞–∑–∞'})`;
            clearUploadedBtn.style.display = 'inline-block';
        }
        
        function validateForm() {
            const useLocal = useLocalBaseRadio.checked;
            let isValid = true;
            if (useLocal) {
                isValid = questionBaseSelect.value !== '';
            } else {
                isValid = uploadedQuestionsData !== null;
            }
            startGameButton.disabled = !isValid;
        }

        // –î–µ—Ç–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–∞–π–ª–∞ –≤–æ–ø—Ä–æ—Å–æ–≤
        function validateQuestionsFile(data) {
            const errors = [];
            
            if (!data || typeof data !== 'object') {
                return { valid: false, error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö: –æ–∂–∏–¥–∞–µ—Ç—Å—è JSON –æ–±—ä–µ–∫—Ç' };
            }
            
            if (!data.categories || !Array.isArray(data.categories)) {
                return { valid: false, error: '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ "categories" –∏–ª–∏ –æ–Ω–æ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º' };
            }
            
            if (data.categories.length === 0) {
                return { valid: false, error: '–ú–∞—Å—Å–∏–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º' };
            }
            
            for (let i = 0; i < data.categories.length; i++) {
                const category = data.categories[i];
                const catNum = i + 1;
                
                if (!category.id) {
                    errors.push(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è ${catNum}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ "id"`);
                }
                if (!category.name || typeof category.name !== 'string') {
                    errors.push(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è ${catNum}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–ª–µ "name"`);
                }
                if (!category.questions || !Array.isArray(category.questions)) {
                    errors.push(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è ${catNum}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–ª–µ "questions"`);
                } else if (category.questions.length === 0) {
                    errors.push(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è ${catNum}: –º–∞—Å—Å–∏–≤ –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º`);
                } else {
                    for (let j = 0; j < category.questions.length; j++) {
                        const question = category.questions[j];
                        const qNum = j + 1;
                        
                        if (!question.text || typeof question.text !== 'string') {
                            errors.push(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è ${catNum}, –≤–æ–ø—Ä–æ—Å ${qNum}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–ª–µ "text"`);
                        }
                        if (!question.options || !Array.isArray(question.options)) {
                            errors.push(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è ${catNum}, –≤–æ–ø—Ä–æ—Å ${qNum}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–ª–µ "options"`);
                        } else if (question.options.length < 2) {
                            errors.push(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è ${catNum}, –≤–æ–ø—Ä–æ—Å ${qNum}: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞`);
                        }
                        if (typeof question.correctAnswer !== 'number') {
                            errors.push(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è ${catNum}, –≤–æ–ø—Ä–æ—Å ${qNum}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–ª–µ "correctAnswer"`);
                        } else if (question.correctAnswer < 0 || question.options && question.correctAnswer >= question.options.length) {
                            errors.push(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è ${catNum}, –≤–æ–ø—Ä–æ—Å ${qNum}: –∏–Ω–¥–µ–∫—Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤`);
                        }
                        if (typeof question.points !== 'number' || question.points <= 0) {
                            errors.push(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è ${catNum}, –≤–æ–ø—Ä–æ—Å ${qNum}: –ø–æ–ª–µ "points" –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º`);
                        }
                    }
                }
            }
            
            if (errors.length > 0) {
                return { valid: false, error: errors[0] + (errors.length > 1 ? ` (–∏ –µ—â–µ ${errors.length - 1} –æ—à–∏–±–æ–∫)` : '') };
            }
            
            return { valid: true };
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑ –≤–æ–ø—Ä–æ—Å–æ–≤ - —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        async function loadQuestionBases() {
            try {
                let files = await getAvailableQuestionFiles();
                
                if (!files || files.length === 0) {
                    try {
                        const response = await fetch('data/questions.json');
                        if (response.ok) {
                            const config = await response.json();
                            if (config.bases && Array.isArray(config.bases)) {
                                files = config.bases.map(base => ({
                                    name: base.file,
                                    path: `data/${base.file}`,
                                    subject: base.name
                                }));
                            }
                        }
                    } catch (e) {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å questions.json:', e);
                        files = [
                            { name: 'history1.json', path: 'data/history1.json', subject: '–ò—Å—Ç–æ—Ä–∏—è' },
                            { name: 'math1.json', path: 'data/math1.json', subject: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞' }
                        ];
                    }
                }
                
                questionBaseSelect.innerHTML = '';
                
                if (!files || files.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '–ë–∞–∑—ã –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
                    questionBaseSelect.appendChild(option);
                    return;
                }
                
                files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.path;
                    option.textContent = file.subject || file.name;
                    questionBaseSelect.appendChild(option);
                });
                validateForm();
            } catch (e) {
                console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑ –≤–æ–ø—Ä–æ—Å–æ–≤:', e);
                questionBaseSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
            }
        }
        
        uploadFileBtn.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                // –î–µ—Ç–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
                const validation = validateQuestionsFile(data);
                
                if (!validation.valid) {
                    showFileError(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: ${validation.error}.<br><br>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –±–∞–∑—É –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞.`);
                    return;
                }
                
                uploadedQuestionsData = data;
                uploadedFileName = file.name;
                
                showFileSuccess(file.name, data.subject);
                validateForm();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:', error);
                showFileError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON —Ñ–æ—Ä–º–∞—Ç');
            }
        });
        
        clearUploadedBtn.addEventListener('click', () => {
            clearUploadedFile();
            validateForm();
        });
        
        useLocalBaseRadio.addEventListener('change', toggleSourceMode);
        useFileUploadRadio.addEventListener('change', toggleSourceMode);
        
        function generatePlayerInputs(count) {
            playerNamesContainer.innerHTML = '';
            for (let i = 1; i <= count; i++) {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `
                    <label for="player${i}">–ò–º—è –∏–≥—Ä–æ–∫–∞ ${i}:</label>
                    <input type="text" id="player${i}" placeholder="–ò–≥—Ä–æ–∫ ${i}" value="–ò–≥—Ä–æ–∫ ${i}">
                `;
                playerNamesContainer.appendChild(div);
            }
        }

        generatePlayerInputs(2);
        loadQuestionBases();
        toggleSourceMode();

        playerCountInput.addEventListener('change', (e) => {
            const count = parseInt(e.target.value);
            if (count >= 2 && count <= 6) {
                generatePlayerInputs(count);
            }
        });
        
        questionBaseSelect.addEventListener('change', validateForm);

        startGameButton.addEventListener('click', () => {
            const playerCount = parseInt(playerCountInput.value);
            const players = [];
            for (let i = 1; i <= playerCount; i++) {
                const name = document.getElementById(`player${i}`).value.trim();
                players.push({ id: i, name: name || `–ò–≥—Ä–æ–∫ ${i}`, score: 0 });
            }

            const gameState = {
                players: players,
                currentPlayer: 0,
                currentQuestion: null,
                answeredQuestions: [],
                gameStatus: 'playing'
            };
            
            if (useLocalBaseRadio.checked) {
                const selectedBase = questionBaseSelect.value;
                if (!selectedBase) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –±–∞–∑—É –≤–æ–ø—Ä–æ—Å–æ–≤');
                    return;
                }
                gameState.questionsFile = selectedBase;
            } else {
                if (!uploadedQuestionsData) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–∞–π–ª —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏');
                    return;
                }
                gameState.uploadedQuestions = uploadedQuestionsData;
                gameState.questionsFile = 'uploaded';
            }

            try {
                localStorage.setItem('gameState', JSON.stringify(gameState));
                console.log('Game state saved:', gameState);
                window.location.href = 'game.html';
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã:', e);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ localStorage.');
            }
        });
    </script>
</body>
</html>
