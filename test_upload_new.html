<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест новой системы загрузки файлов</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .setup-card { max-width: 800px; margin: 0 auto; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .source-options { margin: 20px 0; padding: 20px; border: 2px solid #ddd; border-radius: 8px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: left; }
        .source-options fieldset { border: none; padding: 0; margin: 0; text-align: left; }
        .source-options legend { font-weight: bold; margin-bottom: 15px; padding: 0 10px; color: #333; text-align: left; }
        .radio-label { display: flex; align-items: center; justify-content: flex-start; margin-bottom: 10px; font-weight: 500; padding: 10px; border-radius: 6px; transition: background-color 0.2s; cursor: pointer; text-align: left; white-space: nowrap; }
        .radio-label:hover { background-color: #f0f8ff; }
        .radio-label input { margin-right: 10px; margin-left: 0; transform: scale(1.2); flex-shrink: 0; }
        .section { margin: 20px 0; padding: 20px; border: 2px dashed #ccc; border-radius: 8px; }
        .local-base-section { background: #f8f9fa; }
        .file-upload-section { background: #e7f3ff; display: none; }
        .btn { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 5px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-outline { background: transparent; color: #6c757d; border: 2px solid #6c757d; }
        .uploaded-file-info { margin-top: 10px; padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; }
        #fileInput { margin-bottom: 10px; padding: 5px; }
        .validation-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow: auto; max-height: 300px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>Тест новой системы загрузки вопросов</h1>
    
    <div class="source-options">
        <fieldset>
            <legend>Источник вопросов</legend>
            <label class="radio-label">
                <input type="radio" name="questionSource" id="useLocalBase" value="local" checked>
                Использовать локальную базу вопросов
            </label>
            <label class="radio-label">
                <input type="radio" name="questionSource" id="useFileUpload" value="file">
                Загрузить файл с вопросами
            </label>
        </fieldset>
    </div>
    
    <div id="localBaseSection" class="section local-base-section">
        <h3>Локальная база вопросов</h3>
        <p>Выберите одну из предустановленных баз вопросов:</p>
        <select id="localBaseSelect" style="width: 100%; padding: 10px; margin: 10px 0;">
            <option value="">История (history1.json)</option>
            <option value="">Математика (math1.json)</option>
        </select>
        <div id="localBaseValidation" class="validation-result hidden"></div>
    </div>
    
    <div id="fileUploadSection" class="section file-upload-section">
        <h3>Загрузка файла пользователя</h3>
        <input type="file" id="fileInput" accept=".json">
        <button type="button" id="uploadFileBtn" class="btn btn-primary">Выбрать файл</button>
        <button type="button" id="clearUploadedBtn" class="btn btn-outline hidden">Очистить загруженный файл</button>
        <div id="uploadedFileInfo"></div>
        <div id="fileValidation" class="validation-result hidden"></div>
        <div id="dataPreview" class="hidden">
            <h4>Предварительный просмотр:</h4>
            <pre id="dataContent"></pre>
        </div>
    </div>

    <div style="margin-top: 30px; padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
        <h3>Инструкция по тестированию:</h3>
        <ol>
            <li>По умолчанию выбран режим "Локальная база вопросов" (радиокнопка)</li>
            <li>Переключите радиокнопку, чтобы переключиться на загрузку файла</li>
            <li>В режиме файла нажмите "Выбрать файл" и выберите JSON файл</li>
            <li>Система автоматически проверит корректность данных</li>
            <li>Попробуйте загрузить example_questions.json (корректный) и invalid_questions.json (некорректный)</li>
        </ol>
    </div>

    <script>
        let uploadedQuestionsData = null;
        let uploadedFileName = '';

        // Переключение между режимами
        function toggleSourceMode() {
            const useLocal = document.getElementById('useLocalBase').checked;
            const localSection = document.getElementById('localBaseSection');
            const fileSection = document.getElementById('fileUploadSection');
            
            if (useLocal) {
                localSection.style.display = 'block';
                fileSection.style.display = 'none';
                clearUploadedFile();
            } else {
                localSection.style.display = 'none';
                fileSection.style.display = 'block';
                document.getElementById('localBaseSelect').selectedIndex = -1;
            }
        }

        // Очистка загруженного файла
        function clearUploadedFile() {
            uploadedQuestionsData = null;
            uploadedFileName = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('clearUploadedBtn').classList.add('hidden');
            document.getElementById('uploadedFileInfo').textContent = '';
            document.getElementById('fileValidation').classList.add('hidden');
            document.getElementById('dataPreview').classList.add('hidden');
        }

        // Валидация данных
        function validateQuestionsData(data) {
            if (!data || typeof data !== 'object') {
                return { valid: false, error: 'Некорректный формат данных' };
            }
            
            if (!data.categories || !Array.isArray(data.categories)) {
                return { valid: false, error: 'Отсутствует поле "categories" или оно не является массивом' };
            }
            
            if (data.categories.length === 0) {
                return { valid: false, error: 'Массив категорий не может быть пустым' };
            }
            
            for (let i = 0; i < data.categories.length; i++) {
                const category = data.categories[i];
                if (!category.id || !category.name || !category.questions) {
                    return { valid: false, error: `Категория ${i + 1}: отсутствуют обязательные поля (id, name, questions)` };
                }
                
                if (!Array.isArray(category.questions) || category.questions.length === 0) {
                    return { valid: false, error: `Категория ${i + 1}: отсутствуют вопросы или массив пуст` };
                }
                
                for (let j = 0; j < category.questions.length; j++) {
                    const question = category.questions[j];
                    if (!question.text || !Array.isArray(question.options) || 
                        typeof question.correctAnswer !== 'number' || typeof question.points !== 'number') {
                        return { valid: false, error: `Категория ${i + 1}, вопрос ${j + 1}: отсутствуют обязательные поля` };
                    }
                    
                    if (question.options.length < 2) {
                        return { valid: false, error: `Категория ${i + 1}, вопрос ${j + 1}: должно быть минимум 2 варианта ответа` };
                    }
                    
                    if (question.correctAnswer < 0 || question.correctAnswer >= question.options.length) {
                        return { valid: false, error: `Категория ${i + 1}, вопрос ${j + 1}: индекс правильного ответа выходит за пределы` };
                    }
                }
            }
            
            return { valid: true };
        }

        // Инициализация
        document.getElementById('useLocalBase').addEventListener('change', toggleSourceMode);
        document.getElementById('useFileUpload').addEventListener('change', toggleSourceMode);
        toggleSourceMode();

        // Обработка загрузки файла
        document.getElementById('uploadFileBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });
        
        document.getElementById('fileInput').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.json')) {
                showValidation('fileValidation', 'error', 'Пожалуйста, выберите файл в формате JSON');
                return;
            }
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                const validation = validateQuestionsData(data);
                if (!validation.valid) {
                    showValidation('fileValidation', 'error', `Ошибка валидации: ${validation.error}`);
                    clearUploadedFile();
                    return;
                }
                
                uploadedQuestionsData = data;
                uploadedFileName = file.name;
                
                // Обновляем интерфейс
                document.getElementById('clearUploadedBtn').classList.remove('hidden');
                const subjectName = data.subject || 'Загруженная база';
                document.getElementById('uploadedFileInfo').innerHTML = 
                    `<div class="uploaded-file-info">✅ Загружен: ${file.name} (${subjectName})</div>`;
                
                showValidation('fileValidation', 'success', 'Файл успешно загружен и валидирован!');
                
                // Показываем предварительный просмотр
                document.getElementById('dataContent').textContent = JSON.stringify(data, null, 2);
                document.getElementById('dataPreview').classList.remove('hidden');
                
            } catch (error) {
                console.error('Ошибка загрузки файла:', error);
                showValidation('fileValidation', 'error', `Ошибка при чтении файла: ${error.message}`);
                clearUploadedFile();
            }
        });
        
        // Очистка файла
        document.getElementById('clearUploadedBtn').addEventListener('click', () => {
            clearUploadedFile();
        });

        // Симуляция выбора локальной базы
        document.getElementById('localBaseSelect').addEventListener('change', (event) => {
            if (event.target.value) {
                showValidation('localBaseValidation', 'success', 'Выбрана локальная база вопросов');
            } else {
                document.getElementById('localBaseValidation').classList.add('hidden');
            }
        });

        // Функция для отображения результатов валидации
        function showValidation(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `validation-result ${type}`;
            element.textContent = message;
            element.classList.remove('hidden');
        }
    </script>
</body>
</html>